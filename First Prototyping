#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// I2C LCD (SDA=16, SCL=17)
LiquidCrystal_I2C lcd(0x27, 20, 4);

// Buttons
#define BTN_START 27
#define BTN_MODE  26

// Modes
enum Mode { POMODORO, DEEP };
Mode currentMode = POMODORO;

bool isRunning = false;
bool isStudy = true;

unsigned long previousMillis = 0;
const unsigned long interval = 1000;

int studyMinutes = 25;
int breakMinutes = 5;

int totalSeconds;
long xp = 0;
int streak = 0;

void setup() {
  Wire.begin(17, 16);  // SDA, SCL

  pinMode(BTN_START, INPUT_PULLUP);
  pinMode(BTN_MODE, INPUT_PULLUP);

  lcd.init();
  lcd.backlight();

  setModeTimes();
  displayScreen();
}

void loop() {

  handleButtons();

  if (isRunning) {
    unsigned long currentMillis = millis();

    if (currentMillis - previousMillis >= interval) {
      previousMillis = currentMillis;

      if (totalSeconds > 0) {
        totalSeconds--;

        if (isStudy) {
          xp++;  // Gain XP every study second
        }
      } else {
        switchPhase();
      }

      displayScreen();
    }
  }
}

void handleButtons() {

  // Start / Pause
  if (digitalRead(BTN_START) == LOW) {
    delay(200);
    isRunning = !isRunning;
  }

  // Switch Mode (only when paused)
  if (digitalRead(BTN_MODE) == LOW) {
    delay(200);
    if (!isRunning) {
      if (currentMode == POMODORO)
        currentMode = DEEP;
      else
        currentMode = POMODORO;

      setModeTimes();
      displayScreen();
    }
  }
}

void setModeTimes() {
  if (currentMode == POMODORO) {
    studyMinutes = 25;
    breakMinutes = 5;
  } else {
    studyMinutes = 45;
    breakMinutes = 10;
  }

  isStudy = true;
  totalSeconds = studyMinutes * 60;
}

void switchPhase() {

  if (isStudy) {
    isStudy = false;
    totalSeconds = breakMinutes * 60;
    streak++;   // Completed one study session
  } else {
    isStudy = true;
    totalSeconds = studyMinutes * 60;
  }
}

void displayScreen() {

  lcd.clear();

  // Row 1: Title
  lcd.setCursor(0, 0);
  lcd.print("StudyMate");

  // Row 2: Mode
  lcd.setCursor(0, 1);
  lcd.print("Mode: ");
  if (currentMode == POMODORO)
    lcd.print("Pomodoro");
  else
    lcd.print("Deep Study");

  // Row 3: Timer
  int minutes = totalSeconds / 60;
  int seconds = totalSeconds % 60;

  lcd.setCursor(0, 2);
  lcd.print(isStudy ? "Study " : "Break ");
  lcd.print("Time: ");

  if (minutes < 10) lcd.print("0");
  lcd.print(minutes);
  lcd.print(":");
  if (seconds < 10) lcd.print("0");
  lcd.print(seconds);

  // Row 4: XP & Streak
  lcd.setCursor(0, 3);
  lcd.print("XP:");
  lcd.print(xp);
  lcd.print("  Streak:");
  lcd.print(streak);
}
